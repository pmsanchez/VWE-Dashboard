<div class="students-manager-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="component-title">Student Manager</h2>
        <button class="btn btn-tab active" (click)="fetchSeminars()">ðŸ”„ Refresh Data</button> 
    </div>

    <div class="card bg-lighter-card p-4 shadow-sm content-display">
        
        <div class="seminar-selection mb-4">
            <h3 class="text-primary mb-3">Select Seminar</h3>
            
            <div *ngIf="isLoadingSeminars" class="alert alert-info">Loading seminar options...</div>
            <div *ngIf="seminarErrorMessage" class="alert alert-danger">{{ seminarErrorMessage }}</div>

            <select 
                class="form-select form-control-lg" 
                [(ngModel)]="selectedSeminarId" 
                (change)="onSeminarChange()"
                *ngIf="!isLoadingSeminars && !seminarErrorMessage"
                [disabled]="isLoadingSeminars"
            >
                <option *ngIf="selectedSeminarId === null" [ngValue]="null" disabled>
                    -- Select a Seminar --
                </option>

                <option *ngFor="let seminar of seminars" [ngValue]="convertToString(seminar.id)">
                    {{ seminar.name }}
                </option>
            </select>
        </div>

        <div class="seminar-details-box mb-4" *ngIf="selectedSeminarDetails">
            <h4 class="text-secondary mb-3">Seminar Details</h4>
            <div class="details-grid">
                
                <div class="detail-item">
                    <label class="text-muted">Name:</label>
                    <p class="mb-0 text-primary">{{ selectedSeminarDetails.name }}</p>
                </div>

                <div class="detail-item">
                    <label class="text-muted">Location:</label>
                    <p class="mb-0">
                        {{ selectedSeminarDetails.location_name }} 
                        <span class="text-muted small">({{ selectedSeminarDetails.location_country_code }})</span>
                    </p>
                </div>
                
                <div class="detail-item">
                    <label class="text-muted">Start Date:</label>
                    <p class="mb-0">{{ selectedSeminarDetails.start_date | date }}</p>
                </div>
                
                <div class="detail-item">
                    <label class="text-muted">End Date:</label>
                    <p class="mb-0">{{ selectedSeminarDetails.end_date | date }}</p>
                </div>
            </div>
            
            <div class="mt-3">
                <label class="text-muted">Description:</label>
                <p class="small text-wrap">{{ selectedSeminarDetails.description || 'No description provided.' }}</p>
            </div>
        </div>
        <hr>

        <div class="student-list-view">
            
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="text-secondary mb-0">Students List</h3>
            </div>
           <div class="search-filter-controls mb-4 d-flex align-items-center">
                <input 
                    type="text" 
                    class="form-control me-3"
                    placeholder="Search globally by Name, ID, or Email..."
                    [(ngModel)]="searchTerm"
                    (ngModelChange)="onSearchChange()"
                    style="flex-grow: 1;"
                >
            </div>

            <div *ngIf="selectedSeminarId === null && !isLoadingSeminars" class="alert alert-warning text-center">
                Please select a seminar from the dropdown above to view students.
            </div>

            <div *ngIf="isLoadingStudents" class="alert alert-info text-center">
                Loading students for the selected seminar...
            </div>

            <div *ngIf="studentsErrorMessage" class="alert alert-danger">
                Error: {{ studentsErrorMessage }}
            </div>

            <div *ngIf="!isLoadingStudents && !studentsErrorMessage && students.length === 0 && selectedSeminarId !== null" 
                    class="alert alert-warning text-center">
                No students found for this seminar.
            </div>

            <div *ngIf="!isLoadingStudents && !studentsErrorMessage && students.length > 0 && filteredStudents.length === 0"
                    class="alert alert-warning text-center">
                No students matched your search criteria.
            </div>


            <div class="table-responsive" *ngIf="filteredStudents.length > 0">
                <table class="table table-striped table-hover receipt-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" 
                                    (change)="toggleSelectAll()" 
                                    [checked]="allCurrentPageSelected"
                                    [indeterminate]="isIndeterminate">
                            </th>
                            <th>Name</th>
                            <th>Student ID</th>
                            <th>Email</th>
                            <th>T-Shirt/Hoodie</th>
                            <th>Allergies</th>
                            <th>City</th>
                            <th>Phone</th>
                            <th>Role</th>
                            <th>Diet</th>
                            <th>Status</th>
                            <th>Comments</th>
                            <th>Attendance</th>
                        </tr>
                        
                        <tr>
                            <td>
                                <input type="text" class="form-control form-control-sm" placeholder="Filter Name" 
                                       [(ngModel)]="columnFilters['name']" (ngModelChange)="onFilterChange()">
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm" placeholder="Filter ID" 
                                       [(ngModel)]="columnFilters['stud_id']" (ngModelChange)="onFilterChange()">
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm" placeholder="Filter Email" 
                                       [(ngModel)]="columnFilters['email']" (ngModelChange)="onFilterChange()">
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm" placeholder="Filter Size" 
                                       [(ngModel)]="columnFilters['tshirt_size']" (ngModelChange)="onFilterChange()">
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm" placeholder="Yes/No" 
                                       [(ngModel)]="columnFilters['food_allergies']" (ngModelChange)="onFilterChange()">
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm" placeholder="Filter City" 
                                       [(ngModel)]="columnFilters['city']" (ngModelChange)="onFilterChange()">
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm" placeholder="Filter Phone" 
                                       [(ngModel)]="columnFilters['phone']" (ngModelChange)="onFilterChange()">
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm" placeholder="Filter Role" 
                                       [(ngModel)]="columnFilters['position']" (ngModelChange)="onFilterChange()">
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm" placeholder="Filter Diet" 
                                       [(ngModel)]="columnFilters['diet_type']" (ngModelChange)="onFilterChange()">
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm" placeholder="Filter Status" 
                                       [(ngModel)]="columnFilters['status']" (ngModelChange)="onFilterChange()">
                            </td>
                            <td></td> 
                            <td></td> 
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let student of paginatedStudents"
                            [class.table-primary]="isSelected(student)"
                            (click)="openStudentDetails(student)"
                            class="student-row" 
                        >
                        <td (click)="$event.stopPropagation();"> 
                            <input type="checkbox" 
                                 [checked]="isSelected(student)" 
                                 (change)="toggleSelection(student)">
                        </td>
                            <td>{{ student.name }}</td>
                            <td>{{ student.stud_id || 'N/A' }}</td>
                            <td>{{ student.email || 'N/A' }}</td>
                            <td>{{ student.tshirt_size }} / {{ student.hoodie_size }}</td>
                            <td>
                                <span [class]="student.food_allergies ? 'text-danger' : 'text-success'">
                                    {{ student.food_allergies ? 'YES' : 'No' }}
                                </span>
                                <span *ngIf="student.allergy_details" class="text-muted small d-block">
                                    ({{ student.allergy_details }})
                                </span>
                            </td>
                            <td>{{ student.city }}, {{ student.country_code }}</td>
                            <td>{{ student.phone }}</td>
                            
                            <td>{{ student.position }}</td>
                            <td>{{ student.diet_type }}</td>
                            <td>
                             <span class="badge" [class]="getStatusClass(student.status)">
                                {{ student.status }}
                            </span>
                            </td>
                            <td>
                                <span *ngIf="student.comments" title="{{ student.comments }}">View</span>
                                <span *ngIf="!student.comments">N/A</span>
                            </td>
                            <td>{{ student.seminar_attendances || 0 }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="bulk-actions-group">
            <button 
                class="btn btn-warning me-2" 
                (click)="openBulkUpdateModal()"
                [disabled]="selectedStudentIds.size === 0"
                title="Update selected students"
            >
                Bulk Update ({{ selectedStudentIds.size }})
            </button>

            <button 
        class="btn btn-danger" 
        (click)="performBulkDelete()"
        [disabled]="selectedStudentIds.size === 0 || isDeleting"
        title="Delete selected students permanently"
    >
        <span *ngIf="isDeleting" class="spinner-border spinner-border-sm" aria-hidden="true"></span>
        {{ isDeleting ? 'Deleting...' : 'Delete Selected' }} ({{ selectedStudentIds.size }})
    </button>
            
            </div>

            <nav *ngIf="totalPages > 1" aria-label="Student Pagination">
                <ul class="pagination justify-content-center">
                    <li class="page-item" [class.disabled]="currentPage === 1">
                        <a class="page-link" (click)="changePage(currentPage - 1)">Previous</a>
                    </li>
                    
                    <li class="page-item" *ngFor="let page of [].constructor(totalPages); let i = index" 
                        [class.active]="currentPage === i + 1">
                        <a class="page-link" (click)="changePage(i + 1)">{{ i + 1 }}</a>
                    </li>

                    <li class="page-item" [class.disabled]="currentPage === totalPages">
                        <a class="page-link" (click)="changePage(currentPage + 1)">Next</a>
                    </li>
                </ul>
            </nav>
            
        </div>

    </div>
</div>

<div class="modal-backdrop" *ngIf="isDetailCardOpen"></div>

<div class="student-detail-modal" [class.is-open]="isDetailCardOpen">
    
    <div class="modal-content" *ngIf="selectedStudent">
        <div class="modal-header">
            <h5 class="modal-title">
                {{ selectedStudent.name }}'s Details 
                <span *ngIf="isEditMode" class="badge bg-warning ms-2">Editing</span>
            </h5>
            
            <button type="button" class="btn-close" (click)="closeStudentDetails()" aria-label="Close"></button>
        </div>
        
        <div class="modal-body">
            
            <div *ngIf="updateError" class="alert alert-danger">{{ updateError }}</div>
            <div *ngIf="updateSuccess" class="alert alert-success">Student details updated successfully!</div>
            
            <div class="detail-grid-modal" *ngIf="selectedStudent">
                
                <div class="detail-item">
                    <label>Student ID:</label>
                    <p>{{ selectedStudent.stud_id || 'N/A' }}</p> </div>
                <div class="detail-item">
                    <label>Name:</label>
                    <p *ngIf="!isEditMode">{{ selectedStudent.name }}</p>
                    <input *ngIf="isEditMode && editableStudent" type="text" class="form-control form-control-sm"
                           [(ngModel)]="editableStudent.name" placeholder="Full Name">
                </div>
                <div class="detail-item">
                    <label>Email:</label>
                    <p *ngIf="!isEditMode">{{ selectedStudent.email || 'N/A' }}</p>
                    <input *ngIf="isEditMode && editableStudent" type="email" class="form-control form-control-sm"
                           [(ngModel)]="editableStudent.email" placeholder="Email Address">
                </div>
                
                <div class="detail-item">
                    <label>Phone:</label>
                    <p *ngIf="!isEditMode">{{ selectedStudent.phone || 'N/A' }}</p>
                    <input *ngIf="isEditMode && editableStudent" type="tel" class="form-control form-control-sm"
                           [(ngModel)]="editableStudent.phone" placeholder="Phone Number">
                </div>
                <div class="detail-item">
                    <label>Role:</label>
                    <p *ngIf="!isEditMode">{{ selectedStudent.position || 'N/A' }}</p>
                    <select *ngIf="isEditMode && editableStudent" class="form-select form-select-sm"
                           [(ngModel)]="editableStudent.position">
                            <option *ngFor="let pos of positionsOptions" [ngValue]="pos">
                            {{ pos }}
                             </option>
                    </select>
                </div>
<div class="detail-item">
    <label>Status:</label>
    
    <p *ngIf="!isEditMode">
        <span class="badge" [class]="getStatusClass(selectedStudent.status)">
            {{ selectedStudent.status }}
        </span>
    </p>
    
    <select *ngIf="isEditMode && editableStudent" class="form-select form-select-sm"
            [(ngModel)]="editableStudent.status">
        <option *ngFor="let status of studentStatusOptions" [ngValue]="status">
            {{ status }}
        </option>
    </select>
</div>

                <div class="detail-item">
                    <label>City:</label>
                    <p *ngIf="!isEditMode">{{ selectedStudent.city || 'N/A' }}</p>
                    <input *ngIf="isEditMode && editableStudent" type="text" class="form-control form-control-sm"
                           [(ngModel)]="editableStudent.city" placeholder="City">
                </div>
                <div class="detail-item">
                    <label>Province/State:</label>
                    <p *ngIf="!isEditMode">{{ selectedStudent.province || 'N/A' }}</p>
                    <input *ngIf="isEditMode && editableStudent" type="text" class="form-control form-control-sm"
                           [(ngModel)]="editableStudent.province" placeholder="Province/State">
                </div>
                <div class="detail-item">
                    <label>Country Code:</label>
                    <p *ngIf="!isEditMode">{{ selectedStudent.country_code || 'N/A' }}</p>
                    <input *ngIf="isEditMode && editableStudent" type="text" class="form-control form-control-sm"
                           [(ngModel)]="editableStudent.country_code" placeholder="Country Code (e.g., CA)">
                </div>
<div class="detail-item">
    <label>T-Shirt Size:</label>
    <p *ngIf="!isEditMode">{{ selectedStudent.tshirt_size || 'N/A' }}</p>
    
    <select *ngIf="isEditMode && editableStudent" class="form-select form-select-sm"
            [(ngModel)]="editableStudent.tshirt_size">
        <option *ngFor="let size of sizeOptions" [ngValue]="size">
            {{ size }}
        </option>
    </select>
</div>
<div class="detail-item">
    <label>Hoodie Size:</label>
    <p *ngIf="!isEditMode">{{ selectedStudent.hoodie_size || 'N/A' }}</p>
    
    <select *ngIf="isEditMode && editableStudent" class="form-select form-select-sm"
            [(ngModel)]="editableStudent.hoodie_size">
        <option *ngFor="let size of sizeOptions" [ngValue]="size">
            {{ size }}
        </option>
    </select>
</div>
                <div class="detail-item">
                    <label>Diet Type:</label>
                    <p *ngIf="!isEditMode">{{ selectedStudent.diet_type || 'N/A' }}</p>
                    <select *ngIf="isEditMode && editableStudent" class="form-select form-select-sm"
                           [(ngModel)]="editableStudent.diet_type">
                                   <option *ngFor="let diet of dietTypeOptions" [ngValue]="diet">
            {{ diet }}
        </option>
        </select>
                </div>

                <div class="detail-item">
                    <label>Attendance:</label>
                    <p>{{ selectedStudent.seminar_attendances || 0 }} total seminars</p>
                </div>
                
<div class="detail-section-full alert" 
    [class.alert-danger]="isEditMode ? editableStudent?.food_allergies : selectedStudent.food_allergies" 
    [class.alert-success]="isEditMode ? !editableStudent?.food_allergies : !selectedStudent.food_allergies">
    
    <label class="d-block mb-1">Food Allergies: 
        <span *ngIf="!isEditMode" class="fw-bold">{{ selectedStudent.food_allergies ? 'YES' : 'No' }}</span>
        
        <div *ngIf="isEditMode && editableStudent" class="form-check form-switch d-inline-block ms-2">
             <input type="checkbox" class="form-check-input" id="foodAllergiesCheck"
                   [(ngModel)]="editableStudent.food_allergies">
        </div>
    </label>
    
    <label *ngIf="!isEditMode" class="mb-0 small d-block">Details: </label>
    <p *ngIf="!isEditMode" class="mb-0 small text-wrap">{{ selectedStudent.allergy_details || 'No details.' }}</p>
    
    <textarea *ngIf="isEditMode && editableStudent" class="form-control form-control-sm mt-1" 
              [(ngModel)]="editableStudent.allergy_details" rows="2" placeholder="Allergy details..."></textarea>
</div>
                
                <div class="detail-section-full">
                    <label>Comments / Observations:</label>
                    <p *ngIf="!isEditMode" class="small text-wrap">{{ selectedStudent.comments || selectedStudent.observations || 'No specific comments or observations.' }}</p>
                    <textarea *ngIf="isEditMode && editableStudent" class="form-control form-control-sm mt-1" 
                              [(ngModel)]="editableStudent.comments" rows="3" placeholder="Comments or Observations..."></textarea>
                </div>

            </div>
        </div>
        
        <div class="modal-footer">
            <button *ngIf="!isEditMode" type="button" class="btn btn-secondary" (click)="closeStudentDetails()">Close</button>
            <button *ngIf="!isEditMode" type="button" class="btn btn-primary" (click)="enterEditMode()">
                <i class="bi bi-pencil-square"></i> Edit
            </button>

            <button *ngIf="isEditMode" type="button" class="btn btn-danger" (click)="cancelEditMode()" [disabled]="isUpdating">Cancel</button>
            <button *ngIf="isEditMode" type="button" class="btn btn-success" (click)="confirmUpdate()" [disabled]="isUpdating">
                <span *ngIf="isUpdating" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                {{ isUpdating ? 'Updating...' : 'Confirm Update' }}
            </button>
        </div>
    </div>
</div>

<div class="modal-backdrop" *ngIf="isBulkUpdateModalOpen"></div>

<div class="bulk-update-modal" [class.is-open]="isBulkUpdateModalOpen" *ngIf="isBulkUpdateModalOpen">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">Bulk Update ({{ selectedStudentIds.size }} Students)</h5>
            <button type="button" class="btn-close" (click)="closeBulkUpdateModal()"></button>
        </div>
        
        <div class="modal-body">
            
            <div *ngIf="bulkUpdateStatus.error" class="alert alert-danger">{{ bulkUpdateStatus.error }}</div>
            <div *ngIf="bulkUpdateStatus.success" class="alert alert-success">Bulk update completed successfully!</div>

            <div class="mb-3">
                <label class="form-label fw-bold">1. Select Field:</label>
                <select class="form-select" [(ngModel)]="bulkUpdateField" (ngModelChange)="bulkUpdateValue = null">
                    <option [ngValue]="null" disabled>-- Choose a field --</option>
                    <option value="status">Status</option>
                    <option value="position">Role</option>
                    <option value="diet_type">Diet Type</option>
                    <option value="tshirt_size">T-Shirt Size</option>
                    <option value="hoodie_size">Hoodie Size</option>
                    <option value="food_allergies">Food Allergies (Yes/No)</option>
                    </select>
            </div>

            <div *ngIf="bulkUpdateField" class="mb-4">
                <label class="form-label fw-bold">2. Select New Value:</label>
                
                <select *ngIf="bulkUpdateField === 'status'" class="form-select" [(ngModel)]="bulkUpdateValue">
                    <option [ngValue]="null" disabled>-- Select New Status --</option>
                    <option *ngFor="let status of studentStatusOptions" [ngValue]="status">{{ status }}</option>
                </select>

                <input *ngIf="bulkUpdateField === 'position'" type="text" class="form-control" 
                       [(ngModel)]="bulkUpdateValue" placeholder="Enter new Role (e.g., Staff)">

                <select *ngIf="bulkUpdateField === 'tshirt_size' || bulkUpdateField === 'hoodie_size'" class="form-select" [(ngModel)]="bulkUpdateValue">
                    <option [ngValue]="null" disabled>-- Select New Size --</option>
                    <option *ngFor="let size of sizeOptions" [ngValue]="size">{{ size }}</option>
                </select>

                <input *ngIf="bulkUpdateField === 'diet_type'" type="text" class="form-control" 
                       [(ngModel)]="bulkUpdateValue" placeholder="Enter new Diet Type">
                
                <div *ngIf="bulkUpdateField === 'food_allergies'" class="form-check form-switch mt-2">
                    <input type="checkbox" class="form-check-input" id="bulkAllergyCheck" [(ngModel)]="bulkUpdateValue">
                    <label class="form-check-label" for="bulkAllergyCheck">Student has food allergies</label>
                </div>

                <div *ngIf="bulkUpdateValue !== null" class="mt-3 alert alert-info p-2 small">
                    Selected value: **{{ bulkUpdateValue }}**
                </div>
            </div>

        </div>
        
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeBulkUpdateModal()" [disabled]="isBulkUpdating">Cancel</button>
            <button type="button" class="btn btn-success" (click)="performBulkUpdate()" 
                    [disabled]="!bulkUpdateField || bulkUpdateValue === null || isBulkUpdating || selectedStudentIds.size === 0">
                <span *ngIf="isBulkUpdating" class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                {{ isBulkUpdating ? 'Applying...' : 'Apply Update' }}
            </button>
        </div>
    </div>
</div>